## Converged Database: Modern Development Workshop Day 3

# Optimizador de rutas (Traveling Salesperson Problem)

# Petición TSP

git clone https://github.com/OracleDataManagementSpain/ConvergedDatabase/


❯ git clone https://github.com/OracleDataManagementSpain/ConvergedDatabase/
Cloning into 'ConvergedDatabase'...
remote: Enumerating objects: 694, done.
remote: Counting objects: 100% (185/185), done.
remote: Compressing objects: 100% (149/149), done.
remote: Total 694 (delta 87), reused 64 (delta 33), pack-reused 509
Receiving objects: 100% (694/694), 448.66 MiB | 27.08 MiB/s, done.
Resolving deltas: 100% (301/301), done.
❯ cd ConvergedDatabase/Developers
❯ unzip java_libraries.zip
Archive:  java_libraries.zip
  inflating: okhttp-3.9.1.jar  
  inflating: javax.json-1.1.4.jar  
  inflating: json-simple-1.1.1.jar  
  inflating: okio-1.13.0.jar  


❯ $ORACLE_HOME/jdk/bin/javac -cp "json-simple-1.1.1.jar:$ORACLE_HOME/jdbc/lib/ojdbc11.jar" TSPRequestDBtoGeoJson.java

❯ loadjava -user soe/soe@localhost:1521/pdb3 -genmissing -r json-simple-1.1.1.jar TSPRequestDBtoGeoJson.class


❯ sqlplus sys/Oracle_4U@localhost:1521/pdb3 as sysdba

SQL*Plus: Release 21.0.0.0.0 - Production on Tue Jan 11 12:40:43 2022
Version 21.3.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 21c Enterprise Edition Release 21.0.0.0.0 - Production
Version 21.3.0.0.0

SQL> exec dbms_java.grant_permission('SOE', 'SYS:java.net.SocketPermission', 'maps.oracle.com:80', 'connect,resolve');

PL/SQL procedure successfully completed.

SQL> exit



❯ sqlplus soe/soe@localhost/pdb3

SQL*Plus: Release 21.0.0.0.0 - Production on Mon Apr 11 17:42:59 2022
Version 21.3.0.0.0

Copyright (c) 1982, 2021, Oracle.  All rights reserved.

Last Successful login time: Mon Apr 11 2022 17:35:29 +00:00

Connected to:
Oracle Database 21c Enterprise Edition Release 21.0.0.0.0 - Production
Version 21.3.0.0.0

SQL> CREATE OR REPLACE FUNCTION tsp_geojson_j (start_loc varchar2, loc_2 varchar2, loc3 varchar2) RETURN CLOB
AS LANGUAGE JAVA
NAME 'TSPRequestDBtoGeoJson.getGeoJson(java.lang.String,java.lang.String,java.lang.String) return java.sql.Clob';
/

Function created.


SQL> select tsp_geojson_j ('Calle Urca 6;Majadahonda;28220;Madrid','Calle Gabriel Garcia Marzquez 2;Las Rozas de Madrid;28232;Madrid','Calle Hijuela 6;Villaviciosa de Odon;28670;Madrid') from dual;

TSP_GEOJSON_J('CALLEURCA6;MAJADAHONDA;28220;MADRID','CALLEGABRIELGARCIAMARZQUEZ2
--------------------------------------------------------------------------------
{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"dist":"



SQL> CREATE TABLE tspgeojson (
  id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY (CACHE 5) PRIMARY KEY,
  geojson json);

Table created.


SQL> insert into tspgeojson (geojson) values (tsp_geojson_j ('Calle Jose Echegaray 6;Las Rozas de Madrid;28232;Madrid','Avenida Mirasierra 1;Villanueva de la Cañada;28691;Madrid','Calle Hijuela 6;Villaviciosa de Odon;28670;Madrid'));

1 row created.

SQL> insert into tspgeojson (geojson) values (tsp_geojson_j ('Calle Jose Echegaray 6;Las Rozas de Madrid;28232;Madrid','Calle Picasso 13;Valdemorillo;28210;Madrid','Avenida de los Toreros 2;Sevilla la Nueva;28609;Madrid'));

1 row created.

SQL> insert into tspgeojson (geojson) values (tsp_geojson_j ('Calle Jose Echegaray 6;Las Rozas de Madrid;28232;Madrid','Calle Madrid 39;Brunete;28690;Madrid','Camino de las Huertas 14;Pozuelo de Alarcón;28223;Madrid'));

1 row created.

SQL> commit;

Commit complete.

SQL> exit



# Aplicación APEX para visualizar las rutas

❯ sqlplus soe/soe@localhost/app_root

SQL*Plus: Release 21.0.0.0.0 - Production on Mon Apr 11 18:21:31 2022
Version 21.3.0.0.0

Copyright (c) 1982, 2021, Oracle.  All rights reserved.

Last Successful login time: Mon Apr 11 2022 13:39:43 +00:00

Connected to:
Oracle Database 21c Enterprise Edition Release 21.0.0.0.0 - Production
Version 21.3.0.0.0

SQL> CREATE TABLE tspgeojson (
 id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY (CACHE 5) PRIMARY KEY,
 geojson json); 

Table created.

SQL> create or replace view tspgeojson_v as
select j.id, jt.dist, jt.duration, jt.sdo_val
from containers(tspgeojson) j NESTED geojson.features[*]
COLUMNS (sdo_val SDO_GEOMETRY PATH '$.geometry',
         dist varchar2 PATH '$.properties.dist',
         duration varchar2 PATH '$.properties.time') jt;  

View created.

SQL> exit


select id as display, id as value from tspgeojson_v


ID = :ROUTE


<b>Route &ID.</b><br>
Distance: &DIST.<br>
Duration: &DURATION.



# Creación de un recomendador usando property graph o grafo.


❯ sqlplus sys/Oracle_4U@localhost:1521/app_root as sysdba

SQL*Plus: Release 21.0.0.0.0 - Production on Tue Jan 11 12:40:43 2022
Version 21.3.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 21c Enterprise Edition Release 21.0.0.0.0 - Production
Version 21.3.0.0.0

SQL> grant graph_developer to soe;

Grant succeeded.

SQL> exit



❯ /home/oracle/sqlcl/bin/sql soe/soe@localhost/app_root


SQLcl: Release 21.2 Production on Tue Feb 22 09:17:20 2022

Copyright (c) 1982, 2022, Oracle.  All rights reserved.

Connected to:
Oracle Database 21c Enterprise Edition Release 21.0.0.0.0 - Production
Version 21.3.0.0.0


SQL> CREATE TABLE PRODUCT_INFORMATION 
       (   PRODUCT_ID NUMBER(6,0), 
      PRODUCT_NAME VARCHAR2(50 BYTE) , 
      PRODUCT_DESCRIPTION VARCHAR2(2000 BYTE), 
       CATEGORY_ID NUMBER(4,0), 
       WEIGHT_CLASS NUMBER(1,0), 
       WARRANTY_PERIOD INTERVAL YEAR (2) TO MONTH, 
       SUPPLIER_ID NUMBER(6,0), 
       PRODUCT_STATUS VARCHAR2(20 BYTE), 
      LIST_PRICE NUMBER(8,2), 
      MIN_PRICE NUMBER(8,2), 
     CATALOG_URL VARCHAR2(50 BYTE));

Table PRODUCT_INFORMATION created.

SQL> create or replace view V_PRODUCT_INFORMATION as select * from containers(PRODUCT_INFORMATION);

View V_PRODUCT_INFORMATION created.



SQL> create or replace view V_ORDERS as 
    select j.JSON_DOCUMENT.ORDER_ID.number() as ORDER_ID, 
           j.JSON_DOCUMENT.CUSTOMER_ID.number() as CUSTOMER_ID, 
           j.JSON_DOCUMENT.ORDER_DATE.string() as ORDER_DATE, 
           j.JSON_DOCUMENT.ORDER_TOTAL.string() as ORDER_TOTAL, 
           j.JSON_DOCUMENT.ORDER_MODE.string() as ORDER_MODE
   from containers(PURCHASE_ORDERS) j;

View V_ORDERS created.

SQL> create or replace view V_ORDER_ITEMS as 
    select ORDER_ID || LINE_ITEM_ID id, ORDER_ID, PRODUCT_ID,QUANTITY, UNIT_PRICE
    from 
    (select jt.* 
    from containers(PURCHASE_ORDERS), 
         JSON_TABLE (JSON_DOCUMENT, '$' COLUMNS (
         ORDER_ID number       path '$.ORDER_ID.number()',
         NESTED PATH '$.ITEMS[*]'  COLUMNS(
         PRODUCT_ID  number      path '$.PRODUCT_ID.number()',
         LINE_ITEM_ID number     path '$.LINE_ITEM_ID.number()',
         QUANTITY   number       path '$.QUANTITY.number()',
         UNIT_PRICE number       path '$.UNITPRICE.number()'
         )))jt);

View V_ORDER_ITEMS created.



SQL> select view_name from user_views;

               VIEW_NAME 
________________________ 
V_PRODUCT_INFORMATION    
V_ORDERS                 
V_ORDER_ITEMS            
V_CUSTOMERS              
V_PURCHASE_ORDERS
V_ORDER_STATUS_AX        
V_PURCHASE_ORDERS_AX      



# Creación de grafo en APP_ROOT

SQL> pgql auto on

PGQL Auto enabled for graph=[null], execute=[true], translate=[false]
SQL>


PGQL> create property graph GRAFO1
   vertex tables (
       V_CUSTOMERS key (CUSTOMER_ID) 
         Label CUSTOMER 
         Properties (CUSTOMER_ID,CUST_FIRST_NAME, CUST_LAST_NAME),
       V_ORDERS key (ORDER_ID) 
         Label ORDER 
         Properties (ORDER_ID,ORDER_DATE,ORDER_MODE,ORDER_TOTAL),
       V_PRODUCT_INFORMATION key (PRODUCT_ID) 
         Label PRODUCT 
         Properties (PRODUCT_ID,PRODUCT_NAME,PRODUCT_DESCRIPTION, LIST_PRICE)
   )
   edge tables (
      V_ORDERS as CUST_ORD key (ORDER_ID)
        Source key (CUSTOMER_ID) references V_CUSTOMERS
        Destination key (ORDER_ID) references V_ORDERS
        Label HAS_ORDER
        NO PROPERTIES,
      V_ORDER_ITEMS key (id)
        Source key (ORDER_ID) references V_ORDERS
        Destination key (PRODUCT_ID) references V_PRODUCT_INFORMATION
        Label HAS_PRODUCT
        PROPERTIES (ORDER_ID,PRODUCT_ID,UNIT_PRICE,QUANTITY)
  ) OPTIONS (PG_VIEW);

Graph created


PGQL> pgql auto off

PGQL Auto disabled

SQL> select table_name from user_tables
     where table_name like 'GRAFO1%';

            TABLE_NAME 
______________________ 
GRAFO1_ELEM_TABLE$     
GRAFO1_KEY$            
GRAFO1_LABEL$          
GRAFO1_PROPERTY$       
GRAFO1_SRC_DST_KEY$    



SQL> pgql auto on graph GRAFO1

PGQL Auto enabled for graph=[GRAFO1], execute=[true], translate=[false]

PGQL> select op.QUANTITY, p.LIST_PRICE, p.PRODUCT_NAME 
    from match (c)-[co]->(o:ORDER)-[op]->(p:PRODUCT)
    where c.CUST_FIRST_NAME='john' and c.CUST_LAST_NAME='johnson'
    limit 5;

   QUANTITY    LIST_PRICE                          PRODUCT_NAME 
___________ _____________ _____________________________________ 
          5          3722 9jRvUKRhPrqQkSl                       
          5          3331 AKv9Tb9jMDfRMllD NCODtNP9fPJT mVWV    
          4          2678 eEWjYC l2O7nU6                        
          4          4125 T1p0H3PAklCRXE6b                      
          5          1632  Fi8GNZ2XJUSslzdD rlT6     



# Acceso al grafo desde Java


❯ git clone https://github.com/OracleDataManagementSpain/ConvergedDatabase

Cloning into 'ConvergedDatabase'...
remote: Enumerating objects: 658, done.
remote: Counting objects: 100% (149/149), done.
remote: Compressing objects: 100% (113/113), done.
remote: Total 658 (delta 69), reused 64 (delta 33), pack-reused 509
Receiving objects: 100% (658/658), 403.12 MiB | 23.26 MiB/s, done.
Resolving deltas: 100% (283/283), done.


❯ cd ConvergedDatabase/Developers
❯ ls
AEMETRequest.java  java_libraries.zip  nodeapp2.zip  PgqlQueryPGX.java  Readme.md


❯ javac -cp "/opt/oracle/graph/lib/*"  PgqlQueryPGX.java


❯ java -cp "/opt/oracle/graph/lib/*:."  PgqlQueryPGX
Conectando...
Leyendo datos...
Ejecutando consulta...
Lista de clientes a recomendar productos
+----------------------------------+
| CUST_FIRST_NAME | CUST_LAST_NAME |
+----------------------------------+
| clifford        | mason          |
| franklin        | willis         |
| orlando         | benson         |
| ralph           | morgan         |
| rick            | hansen         |
| chad            | ellis          |
| jesus           | ruiz           |
| leo             | rose           |
| orlando         | benson         |
| john            | johnson        |
+----------------------------------+


# Modelo predictivo python in-database y API Rest


❯ sqlplus sys/Oracle_4U@localhost:1521/app_root as sysdba

SQL*Plus: Release 21.0.0.0.0 - Production on Tue Jan 11 12:40:43 2022
Version 21.3.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 21c Enterprise Edition Release 21.0.0.0.0 - Production
Version 21.3.0.0.0

SQL> grant PYQADMIN to soe;

Grant succeeded.

SQL> exit


❯ sqlplus soe/soe@localhost:1521/app_root 

SQL*Plus: Release 21.0.0.0.0 - Production on Tue Jan 11 12:40:43 2022
Version 21.3.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 21c Enterprise Edition Release 21.0.0.0.0 - Production
Version 21.3.0.0.0

SQL> @/home/oracle/OML4Py/orders_ml_final.sql;

[…]

SQL> exit


# Ejecución del modelo predictivo desde SQL


SELECT *
FROM table(pyqEval(
'{"dist": 12, "trdu": 33.2, "tmed": 3.3, "prec": 0, "weday":2, "ite":1,"oml_connect":1}', 
'{"PRED":"number"}',
'dev_gnb_predict'));


# Exposición y ejecución del modelo predictivo desde REST

DECLARE
  v_Pred NUMBER;
BEGIN

SELECT "PRED" into v_Pred 
FROM table(pyqEval(
'{"dist": '||:dist||', "trdu": '||:trdu||', "tmed":'||:tmed||', "prec": '||:prec||', "weday":'||:weday||', "ite":'||:ite||',"oml_connect":1}', 
'{"PRED":"number"}',
'dev_gnb_predict'));
:v_Pred_Out := v_Pred;

EXCEPTION
   WHEN OTHERS THEN
      :v_Pred_Out := 99;

END;



curl --header "Content-type: application/json" \
--data '{ "dist":12, "trdu":33.2, "tmed":3.3, "prec":0, "weday":2, "ite":1}' \
http://localhost:8080/ords/soe/oml4py/dev_gnb



